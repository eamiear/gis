define(["dojo/_base/declare","esri/graphic","esri/layers/GraphicsLayer","esri/geometry/Point","esri/geometry/webMercatorUtils","esri/toolbars/draw","esri/symbols/PictureMarkerSymbol","esri/dijit/PopupTemplate"],function(e,t,r,i,a,l,o,s){return e(null,{layerQueryLayer:null,constructor:function(){dojo.subscribe("toolBarLoadedEvent",this,"initLayerQuery"),this.defaultSymbol={POINT:{type:"esriSMS",style:"esriSMSCircle",angle:0,color:[255,0,0,255],outline:{type:"esriSLS",style:"esriSLSSolid",width:1.5,color:[255,255,255]},size:6.75,xoffset:0,yoffset:0},IMAGE:{type:"esriPMS",angle:0,width:32,height:32,xoffset:0,yoffset:0,url:baseUrl+"/themes/default/images/tt.png"},TEXT:{type:"esriTS",angle:0,color:[51,51,51,255],font:{family:"微软雅黑",size:9,style:"normal",variant:"normal",weight:"normal"},horizontalAlignment:"center",kerning:!0,rotated:!1,text:"默认文本",xoffset:0,yoffset:0},LINE:{type:"esriSLS",style:"esriSLSSolid",width:1.5,color:[255,0,0,255]},POLYGON:{type:"esriSFS",style:"esriSFSSolid",color:[0,0,0,64],outline:{type:"esriSLS",style:"esriSLSSolid",width:1.5,color:[255,0,0,255]}}},this.layerQueryLayer=new esri.layers.GraphicsLayer({id:"GXX_GIS_QUERYRESULT_LAYER"})},initLayerQuery:function(e){this.toolbar=e,this.map=this.toolbar.map,this.map.addLayer(this.layerQueryLayer)},startDraw:function(e,t,r){this.layerQueryLayer.clear(),this.map.reorderLayer(this.layerQueryLayer,this.map._layers.length-1),this.toolbar.draw(e,t||this.defaultSymbol[e.toUpperCase()],dojo.hitch(this,function(e){r(e?e:null)}))},pullBoxSearch:function(){this.startDraw(l.EXTENT,new SimpleFillSymbol(this.defaultSymbol.POLYGON),dojo.hitch(this,function(e){this.layerQueryLayer.add(e)}))},polygonSearch:function(){this.startDraw(l.POLYGON,new SimpleFillSymbol(this.defaultSymbol.POLYGON),dojo.hitch(this,function(e){this.layerQueryLayer.add(e)}))},circleSearch:function(){this.startDraw(l.CIRCLE,new SimpleFillSymbol(this.defaultSymbol.POLYGON),dojo.hitch(this,function(e){this.layerQueryLayer.add(e);var t=this.queryByGeometry("GXX_Device",e.geometry);dojo.forEach(t,dojo.hitch(this,function(e,t){var r=e.geometry,i=null;switch(t){case 0:i=new o(baseUrl+"/themes/default/images/location/1.png",36,36);break;case 1:i=new o(baseUrl+"/themes/default/images/location/2.png",36,36);break;case 2:i=new o(baseUrl+"/themes/default/images/location/3.png",36,36);break;case 3:i=new o(baseUrl+"/themes/default/images/location/4.png",36,36);break;default:i=new o(baseUrl+"/themes/default/images/location/0.png",36,36)}var a=new s({title:"{title}",description:"{description}"}),l=new Graphic(r,i,{title:"标题"+t,description:"内容"+t},a);this.layerQueryLayer.add(l)}))}))},queryByAttribute:function(e,t,r,i){var a=new SpatialQueryParam;return a.layerId=e,a.attrName=t,a.attrValue=r,a.isLike=i||!0,this.queryByLayerId(1,a)},queryByGeometry:function(e,t){var r=new SpatialQueryParam;return r.layerId=e,r.geometry=t,this.queryByLayerId(2,r)},queryByAttrAndGeo:function(e,t,r,i,a){var l=new SpatialQueryParam;return l.layerId=e,l.geometry=t,l.attrName=r,l.attrValue=i,this.queryByLayerId(3,l)},queryByLayerId:function(e,t){var r=t.layerId,i=t.attrName,a=t.attrValue,l=t.geometry||null,o=t.isLike||!0,s=this.map.getLayer(r),n=null;return s&&(1==e?n=this.getGraphicByAttribute(s,i,a,o):2==e?n=this.getGraphicByGeometry(s,l):3==e&&(n=this.getGraphicByAttributeAndGeometry(s,l,i,a,o))),n},getGraphicBy:function(e,t,r){var i=null;if(e)for(var a=e.graphics,l=0,o=a.length;l<o;++l)if(a[l][t]==r){i=this.features[l];break}return i},getGraphicById:function(e,t){return this.getGraphicBy(e,"id",t)},getAllGraphic:function(e){return e.graphics},getGraphicByAttributeAndGeometry:function(e,t,r,i,a){var l=null,o=this.getGraphicByAttribute(e,r,i,a);return o&&o.lenght>0&&(l=[],dojo.forEach(o,function(e,r){t.contains(e.geometry)&&l.push(e)})),l},getGraphicByGeometry:function(e,t){var r=null;if(e&&t){r=[];for(var i=this.getAllGraphic(e),a=0,l=i.length;a<l;a++){var o=i[a];t.contains(o.geometry.getPoint(0))&&r.push(o)}}return r},getGraphicByAttribute:function(e,t,r,i){var a=null;if(e){var l=null;a=[];for(var o=e.graphics,s=0,n=o.length;s<n;s++)(l=o[s])&&l.attributes&&(i?-1!=l.attributes[t].indexOf(r)&&a.push(l):l.attributes[t]==r&&a.push(l))}return a}})});